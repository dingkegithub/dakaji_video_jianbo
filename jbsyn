#!/bin/bash
LOG="/var/log/jbs.log"
LOG_SIZE=10000000

MULTICAST_PORT=$1
SYN_ROOT_DIR=$2

SYN_DIR="${SYN_ROOT_DIR}/${MULTICAST_PORT}"
SERVER_DIR='gozen@61.128.250.94:/data1/gozen/jianbo'

info() {
    echo "$(%d +%Y-%m-%dT%H:%M:%S): ---------------------------------" >> ${LOG}
    echo "$(%d +%Y-%m-%dT%H:%M:%S): multicast port ${MULTICAST_PORT})" >> ${LOG}
    echo "$(%d +%Y-%m-%dT%H:%M:%S): syn root dir   ${SYN_ROOT_DIR})"   >> ${LOG}
    echo "$(%d +%Y-%m-%dT%H:%M:%S): syn dir        ${SYN_DIR})"        >> ${LOG}
    echo "$(%d +%Y-%m-%dT%H:%M:%S): server dir     ${SERVER_DIR})"     >> ${LOG}
    echo "$(%d +%Y-%m-%dT%H:%M:%S): ---------------------------------" >> ${LOG}
}

log() {
    if [ ! -f $1 ]; then
        touch $1
    else
        log_size=$(ls -l $1 | cut -d ' ' -f5)
        too_bigger=$(echo "${log_size} >= $2" | bc)

        if [ ${too_bigger} -eq 1 ]; then
            rm $1
            touch $1
        fi
    fi
}

remove() {
    cur_dir=$(pwd)
    dir_name=$(dirname $1)
    base_name=$(basename $1)
    cd ${dir_name}
    rm -rf ${base_name}
    cd ${cur_dir}
}

log ${LOG} ${LOG_SIZE}

while true
do
    if [ -d ${SYN_DIR} ]; then
        files=($(ls))
        
        for file in ${files[*]}
        do
            syn_file="${SYN_DIR}/${file}"
            syn_dir=$(cat ${syn_file})

            echo "$(%d +%Y-%m-%dT%H:%M:%S): rsync direction ${syn_dir})" >> ${LOG}
            rsync -P -ave "ssh -p 22102" ${syn_dir} ${SERVER_DIR}

            echo "$(%d +%Y-%m-%dT%H:%M:%S): clean rsynced syn ${syn_dir})" >> ${LOG}
            if [ -f ${syn_file} ]; then
                remove ${syn_file}
            fi
            
            echo "$(%d +%Y-%m-%dT%H:%M:%S): clean rsynced direction ${syn_dir})" >> ${LOG}
            if [ -d ${syn_dir} ]; then
                remove ${syn_dir}
            fi
        done
    else
        log ${LOG} ${LOG_SIZE}
        echo "$(%d +%Y-%m-%dT%H:%M:%S): not found need rsync sleeping..." >> ${LOG}
        info
        sleep 5
    fi
done

