#!/bin/bash
CH_NAME=$1
VIDEO_PORT=$2
COMP_ROOT_DIR=$3
RSYNC_ROOT_DIR=$4

BIT_RATE=400k
LOG_SIZE=10000000
LOG="/var/log/jbc.${MULTICAST_PORT}"

#CH_COMP_DIR="${COMP_ROOT_DIR}/${VIDEO_PORT}"
CH_COMP_DIR="${COMP_ROOT_DIR}"

TEST_MODE=1

log() {
    if [ ! -f ${LOG} ]; then
        touch ${LOG}
    else
        log_size=$(ls -l ${LOG} | cut -d ' ' -f5)
        too_bigger=$(echo "${log_size} >= ${LOG_SIZE}" | bc)

        if [ ${too_bigger} -eq 1 ]; then
            rm ${LOG}
            touch ${LOG}
        fi
    fi

    echo "$(%d +%Y-%m-%dT%H:%M:%S) $1" >> ${LOG}
}

while true
do
    if [ -d ${CH_COMP_DIR} ]; then
        files=$(ls ${CH_COMP_DIR})
        for file in ${files}
        do
            cmp_meta_file="${CH_COMP_DIR}/${file}"
            record_file=$(cat ${cmp_meta_file})

            meta=(${record_file//\// })
            meta_size=${#meta[@]}
            meta_ch_port=${record_meta[$(echo "${meta_size}-5" | bc)]}
            meta_ch_name=${record_meta[$(echo "${meta_size}-4" | bc)]}
            meta_ch_date=${record_meta[$(echo "${meta_size}-3" | bc)]}
            meta_ch_hour=${record_meta[$(echo "${meta_size}-2" | bc)]}
            meta_ch_file=${record_meta[$(echo "${meta_size}-1" | bc)]}
           
            comp_out_dir="${RSYNC_ROOT_DIR}/${meta_ch_port}/${meta_ch_name}/${meta_ch_date}/${meta_ch_hour}"
            mkdir -p ${comp_out_dir}
            comp_out_file="${comp_out_dir}/${meta_ch_file}"

            if [ ${TEST_MODE} -eq 1 ]; then
                touch ${comp_out_file}
            else
                /usr/bin/ffmpeg -i ${record_file} -b ${BIT_RATE} ${comp_out_file}
            fi

            if [ -f ${cmp_meta_file} ]; then
                remove ${cmp_meta_file}
            fi
           
            log "INFO: clean compress meta file ${cmp_meta_file}"
        done
    else
        log "WARN: not found need rsync sleeping..."
        info
        sleep 30
    fi
done

