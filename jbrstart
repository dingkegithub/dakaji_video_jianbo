#!/bin/bash
LOG="/var/log/jbrstart.log"
LOG_SIZE=10000000

JBR_CONF_DIR="/etc/jb"
JBR_CONF="jbr.conf"

log() {
    if [ ! -f ${LOG} ]; then
        touch ${LOG}
    else
        log_size=$(ls -l ${LOG} | cut -d ' ' -f5)
        too_bigger=$(echo "${log_size} >= ${LOG_SIZE}" | bc)

        if [ ${too_bigger} -eq 1 ]; then
            rm ${LOG}
            touch ${LOG}
        fi
    fi

    echo "$(date +%Y-%m-%dT%H:%M:%S) $1" >> ${LOG}
}

if [ ! -d ${JBR_CONF_DIR} ]; then
    #echo "$(date +%Y-%m-%dT%H:%M:%S) ERROR: no ${JBR_CONF} direction exist !!!"
    msg="ERROR: no ${JBR_CONF} direction exist !!!"
    log "${msg}"
fi

CONF_DIR_LIST=$(ls ${JBR_CONF_DIR})

for dir in $(ls ${JBR_CONF_DIR})
do
    conf_dir="${JBR_CONF_DIR}/${dir}" 
    if [ ! -d ${conf_dir} ]; then
        #echo "$(date +%Y-%m-%dT%H:%M:%S) WARN: file not exist or not dir ${conf_dir}"
        msg="WARN: file not exist or not dir ${conf_dir}"
        log "${msg}"
        continue
    fi

    conf_file="${conf_dir}/${JBR_CONF}"
    if [ ! -f ${conf_file} ]; then
        echo "$(date +%Y-%m-%dT%H:%M:%S) ERROR: file not exist ${conf_file}"
        msg="ERROR: file not exist ${conf_file}"
        log "${msg}"
        continue
    fi

    declare -A m=()

    while read line
    do
        key=$(echo ${line} | cut -d '=' -f1)
        value=$(echo ${line} | cut -d '=' -f2)
        m["${key}"]="${value}"
    done < ${conf_file}

    msg="(jbrecord ${m['CHANNEL_NAME']} ${m['IP']} ${m['PORT']} ${m['ROOT_DIR']} ${m['COMP_DIR']} ${m['VIDEO_SLICE']} &)"
    log "INFO: run cmd: ${msg}"
    #(jbrecord ${conf['CHANNEL_NAME']} ${conf['IP']} ${conf['PORT']} ${conf['ROOT_DIR']} ${conf['SYN_DIR']} ${conf['VIDEO_SLICE']} &)
done

